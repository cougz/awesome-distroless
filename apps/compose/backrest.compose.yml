# Docker Compose for backrest distroless stack
name: "backrest"

services:
  backrest:
    image: distroless-backrest:1.9.0
    ports:
      - "9898:9898"
    environment:
      BACKREST_PORT: "0.0.0.0:9898"
      BACKREST_DATA: "/var/lib/backrest/data"
      BACKREST_CONFIG: "/etc/backrest/config.json"
      XDG_CACHE_HOME: "/var/cache/backrest"
      TMPDIR: "/tmp"
      TZ: ${TZ:-UTC}
      BACKREST_RESTIC_COMMAND: "/usr/local/bin/restic"
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
    volumes:
      - backrest_data:/var/lib/backrest/data
      - backrest_config:/etc/backrest
      - backrest_cache:/var/cache/backrest
      - ${BACKUP_SOURCE_PATH:-./data}:/userdata:ro
      - ${LOCAL_REPO_PATH:-./repos}:/repos
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:size=100M,noexec,nosuid,nodev
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

volumes:
  backrest_data:
  backrest_config:
  backrest_cache: